#################################### Logs ######################################

declare -rg PS4='+(${LINENO}) ${FUNCNAME[0]}(): '
declare -rg LOG_DIR='/var/games/tetris'
declare -rg HIGHSCORE_LOG="$LOG_DIR/highscores.ths"
declare -rg SETTINGS_LOG="$LOG_DIR/settings.txt"
declare -rg ERROR_LOG="$LOG_DIR/error.log"
declare -rg DEBUG_LOG="$LOG_DIR/debug.log"

if (( ${BASH_VERSINFO[0]} == 4 && ${BASH_VERSINFO[1]} < 4 )); then
    declare -rg LEGACY=true
else
    declare -rg LEGACY=false
fi

################################## Screens #####################################

if ! $_inTTY; then
    declare -arg MAIN_SCREEN=(
        '┌────────────────────────────────────────┐'
        '│                                        │'
        '│  █▛██▜█ ██ ▜█ █▛██▜█ ██ █▙  ██  ▟▙ ▜█  │'
        '│  ▛ ██ ▜ ██  ▜ ▛ ██ ▜ ██ ██  ██  ▜█▙ ▜  │'
        '│    ██   ██ █    ██   ██ ▛   ██   ▜█▙   │'
        '│    ██   ██  ▟   ██   ██ ▙   ██  ▙ ▜█▙  │'
        '│    ██   ██ ▟█   ██   ██ █▙  ██  █▙ ▜▛  │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                           © Ben Pitman │'
        '└────────────────────────────────────────┘'
    )
    declare -arg FIELD_SCREEN=(
        '┌────────────────────┬───────────────────┐'
        '│                    │  ╔═════════════╗  │'
        '│                    ├──╢  S C O R E  ╟──┤'
        '│                    │  ╚═════════════╝  │'
        '│                    ╞═══════════════════╡'
        '│                    │             0     │'
        '│                    ╞═══════════════════╡'
        '│                    │                   │'
        '│                    │  ╔═════════════╗  │'
        '│                    │  ║  L E V E L  ║  │'
        '│                    │  ║          0  ║  │'
        '│                    │  ╚═════════════╝  │'
        '│                    │  ╔═════════════╗  │'
        '│                    │  ║  L I N E S  ║  │'
        '│                    │  ║          0  ║  │'
        '│                    │  ╚═════════════╝  │'
        '│                    │                   │'
        '│                    │  ╔══════════╗     │'
        '│                    │  ║          ║     │'
        '│                    │  ║          ║     │'
        '│                    │  ║          ║     │'
        '│                    │  ║          ║     │'
        '│                    │  ╚══════════╝     │'
        '└────────────────────┴───────────────────┘'
    )
    declare -arg SCORES_SCREEN=(
        '┌────────────────────────────────────────┐'
        '│            ╔═════════════╗             │'
        '├────────────╢ S C O R E S ╟─────────────┤'
        '│            ╚═════════════╝             │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '└────────────────────────────────────────┘'
    )
    declare -arg SETTINGS_SCREEN=(
        '┌────────────────────────────────────────┐'
        '│          ╔═════════════════╗           │'
        '├──────────╢ S E T T I N G S ╟───────────┤'
        '│          ╚═════════════════╝           │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                      ┌──────────────┐  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      └──────────────┘  │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '└────────────────────────────────────────┘'
    )
else
    declare -arg MAIN_SCREEN=(
        '┌────────────────────────────────────────┐'
        '│                                        │'
        '│  ██████ █████ ██████ █████  ██  █████  │'
        '│    ██   ██      ██   ██  ██ ██ ██      │'
        '│    ██   ████    ██   ████   ██   ██    │'
        '│    ██   ██      ██   ██  ██ ██     ██  │'
        '│    ██   █████   ██   ██  ██ ██ █████   │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                           © Ben Pitman │'
        '└────────────────────────────────────────┘'
    )
    declare -arg FIELD_SCREEN=(
        '┌────────────────────┬───────────────────┐'
        '│                    │  ┌─────────────┐  │'
        '│                    ├──┤  S C O R E  ├──┤'
        '│                    │  └─────────────┘  │'
        '│                    ├───────────────────┤'
        '│                    │             0     │'
        '│                    ├───────────────────┤'
        '│                    │                   │'
        '│                    │  ┌─────────────┐  │'
        '│                    │  │  L E V E L  │  │'
        '│                    │  │          0  │  │'
        '│                    │  └─────────────┘  │'
        '│                    │  ┌─────────────┐  │'
        '│                    │  │  L I N E S  │  │'
        '│                    │  │          0  │  │'
        '│                    │  └─────────────┘  │'
        '│                    │                   │'
        '│                    │  ┌──────────┐     │'
        '│                    │  │          │     │'
        '│                    │  │          │     │'
        '│                    │  │          │     │'
        '│                    │  │          │     │'
        '│                    │  └──────────┘     │'
        '└────────────────────┴───────────────────┘'
    )
    declare -arg SCORES_SCREEN=(
        '┌────────────────────────────────────────┐'
        '│            ┌─────────────┐             │'
        '├────────────┤ S C O R E S ├─────────────┤'
        '│            └─────────────┘             │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '└────────────────────────────────────────┘'
    )
    declare -arg SETTINGS_SCREEN=(
        '┌────────────────────────────────────────┐'
        '│          ┌─────────────────┐           │'
        '├──────────┤ S E T T I N G S ├───────────┤'
        '│          └─────────────────┘           │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '│                      ┌──────────────┐  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      │              │  │'
        '│                      └──────────────┘  │'
        '│                                        │'
        '│                                        │'
        '│                                        │'
        '└────────────────────────────────────────┘'
    )
fi

############################## States and Modes ################################

declare -arg COLOUR_MODES=(
    'NORMAL'
    'SIMPLE'
    'NOIR'
    'BLEACH'
)
setColourMode()
{
    _colourMode=${COLOUR_MODES[$1]}
}

declare -arg GAME_MODES=(
    'NORMAL'
)
setGameMode()
{
    _gameMode=${GAME_MODES[$1]}
}

declare -Arg STATES=(
    ['MAIN']=0
    ['FIELD']=1
    ['SCORES']=2
    ['SETTINGS']=3
    ['GAME_OVER']=4
)
setState()
{
    _state=${STATES[$1]}
}

############################### Menu Navigation ################################

declare -rg START_POSITION='2,8'

declare -Arg MAIN_OPTIONS=(
    ['MAX']=3

    ['0']=' N E W   G A M E '
    ['0,Y']=11
    ['0,X']=13

    ['1']=' S C O R E S '
    ['1,Y']=14
    ['1,X']=15

    ['2']=' S E T T I N G S '
    ['2,Y']=17
    ['2,X']=13

    ['3']=' Q U I T '
    ['3,Y']=20
    ['3,X']=17
)

# Settings menu options
declare -Arg SETTINGS_OPTIONS=(
    ['MAX']=2

    ['0']=' COLOUR  MODE '
    ['0,Y']=10
    ['0,X']=6

    ['1']=' GAME  MODE '
    ['1,Y']=12
    ['1,X']=7

    ['2']=' BACK '
    ['2,Y']=22
    ['2,X']=10
)

# Opens up the submenu for selection
declare -Arg SETTINGS_CLEAR_SUB_MENU=(
    ['MAX']=11

    ['Y']=9
    ['X']=25

     ['0']='┌────────────┐'
     ['1']='│            │'
     ['2']='│            │'
     ['3']='│            │'
     ['4']='│            │'
     ['5']='│            │'
     ['6']='│            │'
     ['7']='│            │'
     ['8']='│            │'
     ['9']='│            │'
    ['10']='└────────────┘'
)

# Clears the chosen items for repopulation
declare -Arg SETTINGS_SUB_MENU=(
    ['MAX']=0
    ['WIDTH']=11

    ['0']='_colourMode'
    ['0,Y']=10
    ['0,X']=26

    ['CLEAR']='              '
    ['CLEAR,Y']=9
    ['CLEAR,X']=25
    ['CLEAR,MAX']=11
)

# Settings colour mode submenu options
declare -Arg SETTINGS_COLOUR_SUB_OPTIONS=(
    ['MAX']=3

    ['0']='  NORMAL  '
    ['0,Y']=11
    ['0,X']=27

    ['1']='  SIMPLE  '
    ['1,Y']=13
    ['1,X']=27

    ['2']='   NOIR   '
    ['2,Y']=15
    ['2,X']=27

    ['3']='  BLEACH  '
    ['3,Y']=17
    ['3,X']=27
)

declare -Arg SETTINGS_GAME_SUB_OPTIONS=(
    ['MAX']=1

    ['0']='  NORMAL  '
    ['0,Y']=11
    ['0,X']=27
)

declare -Arg SCORES_OPTIONS=(
    ['MAX']=0

    ['0']=' BACK '
    ['0,Y']=22
    ['0,X']=19
)

declare -Arg SCORES=(
    ['MAX']=13
    ['WIDTH']=30

    ['Y']=7
    ['X']=7
)

declare -Arg FIELD_OPTIONS=(
    ['SCORE,X']=28
    ['SCORE,Y']=6
    ['SCORE,WIDTH']=9

    ['LEVEL,X']=28
    ['LEVEL,Y']=11
    ['LEVEL,WIDTH']=9

    ['LINES,X']=28
    ['LINES,Y']=15
    ['LINES,WIDTH']=9

    ['ALERT,PAUSED']='P A U S E D'
    ['ALERT,SINGLE']='S I N G L E'
    ['ALERT,DOUBLE']='D O U B L E'
    ['ALERT,TRIPLE']='T R I P L E'
    ['ALERT,TETRIS']='T E T R I S'
    ['ALERT,GAME_OVER']='GAME   OVER'
    ['ALERT,X']=27
    ['ALERT,Y']=8
)

declare -Arg NEXT_PIECE=(
    ['R,X']=26  # Reset
    ['R,Y']=19

    ['I,X']=27
    ['I,Y']=19

    ['J,X']=28
    ['J,Y']=20

    ['L,X']=28
    ['L,Y']=20

    ['O,X']=29
    ['O,Y']=20

    ['S,X']=28
    ['S,Y']=20

    ['T,X']=28
    ['T,Y']=20

    ['Z,X']=28
    ['Z,Y']=20
)

################################ Tetrominoes ###################################

declare -rg BLANK='\u0020\u0020'
declare -rg BLOCK='\u2588\u2588'

setColours()
{
    case $_colourMode in
        'NORMAL')
            declare -ag COLOURS=(
                [0]=$'\e[0m'        # Default
                [1]=$'\e[38;5;43m'  # Cyan
                [2]=$'\e[38;5;27m'  # Blue
                [3]=$'\e[38;5;166m' # Orange
                [4]=$'\e[38;5;178m' # Yellow
                [5]=$'\e[38;5;76m'  # Green
                [6]=$'\e[38;5;128m' # Purple
                [7]=$'\e[38;5;160m' # Red
                [8]=$'\e[0;97m'     # White
            )
        ;;
        'SIMPLE')
            declare -ag COLOURS=(
                [0]=$'\e[0m'        # Default
                [1]=$'\e[38;5;27m'  # Blue
                [2]=$'\e[38;5;128m' # Purple
                [3]=$'\e[38;5;178m' # Yellow
                [4]=$'\e[38;5;76m'  # Green
                [5]=$'\e[38;5;43m'  # Cyan
                [6]=$'\e[38;5;205m' # Pink
                [7]=$'\e[38;5;160m' # Red
                [8]=$'\e[0;97m'     # White
            )
        ;;
        'NOIR')
            declare -ag COLOURS=(
                [0]=$'\e[0;97m'   # white
                [1]=$'\e[0;97m'
                [2]=$'\e[0;97m'
                [3]=$'\e[0;97m'
                [4]=$'\e[0;97m'
                [5]=$'\e[0;97m'
                [6]=$'\e[0;97m'
                [7]=$'\e[0;97m'
                [8]=$'\e[0;97m'
            )
        ;;
        'BLEACH')
            declare -ag COLOURS=(
                [0]=$'\e[38;5;232;47m'   # Inverted white
                [1]=$'\e[38;5;232;47m'
                [2]=$'\e[38;5;232;47m'
                [3]=$'\e[38;5;232;47m'
                [4]=$'\e[38;5;232;47m'
                [5]=$'\e[38;5;232;47m'
                [6]=$'\e[38;5;232;47m'
                [7]=$'\e[38;5;232;47m'
                [8]=$'\e[38;5;232;47m'
            )
        ;;
    esac
}

declare -Arg COLOURS_LOOKUP=(
    [R]=0   # Reset
    [I]=1
    [J]=2
    [L]=3
    [O]=4
    [S]=5
    [T]=6
    [Z]=7
    [W]=8   # White
)

declare -arg PIECES=( 'I' 'J' 'L' 'O' 'S' 'T' 'Z' )

declare -arg I=(
    '0,1 1,1 2,1 3,1'
    '2,0 2,1 2,2 2,3'
    '0,2 1,2 2,2 3,2'
    '1,0 1,1 1,2 1,3'
)

declare -arg J=(
    '0,0 0,1 1,1 2,1'
    '1,0 2,0 1,1 1,2'
    '0,1 1,1 2,1 2,2'
    '1,0 1,1 0,2 1,2'
)

declare -arg L=(
    '2,0 0,1 1,1 2,1'
    '1,0 1,1 1,2 2,2'
    '0,1 1,1 2,1 0,2'
    '0,0 1,0 1,1 1,2'
)

declare -arg O=(
    '0,0 1,0 0,1 1,1'
    '0,0 1,0 0,1 1,1'
    '0,0 1,0 0,1 1,1'
    '0,0 1,0 0,1 1,1'
)

declare -arg S=(
    '1,0 2,0 0,1 1,1'
    '1,0 1,1 2,1 2,2'
    '1,1 2,1 0,2 1,2'
    '0,0 0,1 1,1 1,2'
)

declare -arg T=(
    '1,0 0,1 1,1 2,1'
    '1,0 0,1 1,1 1,2'
    '0,1 1,1 2,1 1,2'
    '1,0 1,1 2,1 1,2'
)

declare -arg Z=(
    '0,0 1,0 1,1 2,1'
    '2,0 1,1 2,1 1,2'
    '0,1 1,1 1,2 2,2'
    '1,0 0,1 1,1 0,2'
)
